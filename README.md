# Идемпотентное API
Задание №6. OTUS
![image](https://user-images.githubusercontent.com/60660331/182458140-cad45dfb-a189-4869-8602-bba9af908b45.png)

Для обеспечения идемпотентности использовался шаблон Идемпонетный получатель.
1. Пользователь создает учетную запись в сервисе Авторизации.
2. Пользователь авторизируется в сервисе Авторизации. 
3. После успешной авторизации сервис отдает JWT токен в содержимом которого сохраняется идентификатор пользователя.
Идентификатор пользователя используется сервисов Заказов для ограничения доступа только к своим заказами.
4. При создании заказа, сервис получив от пользователя данные, добавляет к ним еще идентификатор заказчика из JWT-токена и вычисляет хэш от его содержимого. 
В БД стоит ограничение на уникальность хэша заказа. Если заказа с таким же хэшем нет, то заказ создается и пользователю возвращается в ответ номер его заказа и хэш заказа.
5. При попытке повторного создания заказа с теми же данными сервис обнаруживает заказ с такми же хэшем и возвращает пользователю его номер и хэш.
6. При изменении содержимого заказа пользователь передает хэш и номер изменяемого заказа.
7. Сервис находит в БД заказ с переданным номером, проверяет является ли текущей пользователь заказчиком в заказе, если нет сервис выдает ошибку Unautorized.
8. Если пользователь является заказчиком, то сверяется номер хэш заказа в БД и хэш изменяемого заказа, полученный от пользователя. 
Если версии совпадают, заказ обновляется и пользователю возвращается обновленный заказ с новым хэшем (новая версия заказа).
Если версии не совпадают, то возвращается 400 ошибка с текстом "Версия обновляемого заказа отличается от версии в БД". 
Клиент получает последнюю версию заказа и повторяет операцию.

**Инструкция по установке**
1. Поставить NGINX ингресс через helm, если не установлен
```
helm upgrade --install ingress-nginx ingress-nginx --repo https://kubernetes.github.io/ingress-nginx --namespace ingress-nginx --create-namespace --set controller.admissionWebhooks.enabled=false
```
2. Развернуть сервисы через helm
```
helm install orders ./helm-chart
```
3. Протестировать работоспособность с помощью newman:
```
newman run IdempotentApi.postman_collection.json
```
4. Удаление сервисов
```
helm uninstall orders
```
